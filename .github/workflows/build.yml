name: Build packages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container: archlinux:base-devel

    steps:
      - uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          # Update system and install dependencies
          pacman -Syu --noconfirm
          pacman -S --noconfirm npm fuse2 zlib

          # Create non-root builder user
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder .

      - name: Import GPG key
        run: echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

      - name: Build packages
        run: |
          for pkg in gemini-cli rpi-imager; do
            if [ -d "$pkg" ]; then
              echo "==> Building $pkg"
              su builder -c "cd $pkg && makepkg -s --noconfirm"
            fi
          done

      - name: Sign packages and create repo
        run: |
          mkdir -p repo

          # Copy and sign packages
          for pkg in */*.pkg.tar.zst; do
            if [ -f "$pkg" ]; then
              cp "$pkg" repo/
              gpg --batch --yes --detach-sign --no-armor "repo/$(basename $pkg)"
            fi
          done

          # Create and sign repo database
          cd repo
          repo-add --sign --key ${{ secrets.GPG_KEY_ID }} m-wells.db.tar.gz *.pkg.tar.zst

      - name: Upload to release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          files: repo/*
          token: ${{ secrets.GITHUB_TOKEN }}
