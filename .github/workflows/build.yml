name: Build packages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Rebuild all packages'
        type: boolean
        default: false
      fix_signatures:
        description: 'Fix database signatures without rebuilding'
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    outputs:
      matrix: ${{ steps.scan.outputs.matrix }}
      removed: ${{ steps.scan.outputs.removed }}
      run_publish: ${{ steps.scan.outputs.run_publish }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup.sh

      - name: Prepare build matrix
        id: scan
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_REBUILD: ${{ inputs.force_rebuild }}
          FIX_SIGNATURES: ${{ inputs.fix_signatures }}
        run: ./scripts/ci/prepare.sh

      - name: Upload Repository DB
        uses: actions/upload-artifact@v4
        with:
          name: repo-db
          path: repo/
          compression-level: 0

  build:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.matrix)[0] != null }}
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup.sh

      - name: Build and Test ${{ matrix.package }}
        run: ./scripts/ci/build.sh ${{ matrix.package }}

      - name: Upload Package Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.package }}
          path: ${{ matrix.package }}/*.pkg.tar.zst
          compression-level: 0

  publish:
    needs: [prepare, build]
    # Run if prepare succeeded, and build either succeeded or was skipped (no work), AND we are told to publish
    if: |
      always() && 
      needs.prepare.result == 'success' && 
      (needs.build.result == 'success' || needs.build.result == 'skipped') && 
      needs.prepare.outputs.run_publish == 'true' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup.sh

      - name: Import GPG key
        run: echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

      - name: Download Repository DB
        uses: actions/download-artifact@v4
        with:
          name: repo-db
          path: repo

      - name: Download Built Packages
        # Only download if build job ran
        if: needs.build.result == 'success'
        uses: actions/download-artifact@v4
        with:
          pattern: pkg-*
          path: repo-artifacts
          merge-multiple: true

      - name: Finalize Repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          REMOVED_JSON: ${{ needs.prepare.outputs.removed }}
        run: ./scripts/ci/publish.sh

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create release if it doesn't exist
          gh release view latest --repo ${{ github.repository }} || \
            gh release create latest --repo ${{ github.repository }} --title "Packages" --notes "Arch Linux binary packages"

          # Upload all contents of repo/ (excluding raw tarballs if we only want DBs and pkgs)
          # We sort -u to deduplicate if any globs overlap
          FILES_TO_UPLOAD=$(ls repo/*.pkg.tar.zst repo/*.sig repo/*.db.tar.gz repo/*.files.tar.gz repo/*.db.sig repo/*.files.sig repo/*.db repo/*.files 2>/dev/null | sort -u | tr '\n' ' ')

          if [ -n "$FILES_TO_UPLOAD" ]; then
             echo "Uploading: $FILES_TO_UPLOAD"
             gh release upload latest $FILES_TO_UPLOAD --repo ${{ github.repository }} --clobber
          else
             echo "No files to upload."
          fi
