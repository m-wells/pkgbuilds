name: Build packages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container: archlinux:base-devel

    steps:
      - uses: actions/checkout@v6

      - name: Setup build environment
        run: |
          # Update system and install dependencies
          pacman -Syu --noconfirm
          pacman -S --noconfirm jq npm fuse2 zlib github-cli

          # Create non-root builder user
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder .

      - name: Import GPG key
        run: echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

      - name: Detect and validate packages
        id: changes
        run: |
          # Auto-detect all packages (directories containing PKGBUILD)
          ALL_PACKAGES=$(find . -maxdepth 2 -name PKGBUILD -printf '%h\n' | sed 's|^\./||' | sort | tr '\n' ' ' | xargs)
          echo "All packages: $ALL_PACKAGES"
          echo "all=$ALL_PACKAGES" >> $GITHUB_OUTPUT

          # Validate: directory name must match pkgname
          ERRORS=0
          for pkg in $ALL_PACKAGES; do
            pkgname=$(grep '^pkgname=' "$pkg/PKGBUILD" | cut -d'=' -f2)
            if [ "$pkg" != "$pkgname" ]; then
              echo "ERROR: Directory '$pkg' does not match pkgname '$pkgname'"
              ERRORS=$((ERRORS + 1))
            fi
          done
          if [ $ERRORS -gt 0 ]; then
            echo "Validation failed: directory names must match pkgname in PKGBUILD"
            exit 1
          fi

          # Get list of changed files via GitHub API
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" | \
              jq -r '.[].filename')
          else
            CHANGED=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}" | \
              jq -r '.files[].filename')
          fi

          # Determine which packages changed
          PACKAGES=""
          for pkg in $ALL_PACKAGES; do
            if echo "$CHANGED" | grep -q "^${pkg}/" || [ -z "$CHANGED" ]; then
              PACKAGES="$PACKAGES $pkg"
            fi
          done

          # If workflow file changed, rebuild all
          if echo "$CHANGED" | grep -q "^\.github/"; then
            PACKAGES="$ALL_PACKAGES"
          fi

          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "Changed packages:$PACKAGES"

      - name: Download existing repo database
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          mkdir -p repo
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/latest"
          curl -sL -f "${RELEASE_URL}/m-wells.db.tar.gz" -o repo/m-wells.db.tar.gz || echo "No existing database"
          curl -sL -f "${RELEASE_URL}/m-wells.files.tar.gz" -o repo/m-wells.files.tar.gz || true

      - name: Build changed packages
        run: |
          for pkg in ${{ steps.changes.outputs.packages }}; do
            if [ -d "$pkg" ]; then
              echo "==> Building $pkg"
              su builder -c "cd $pkg && makepkg -s --noconfirm"
            fi
          done

      - name: Sign packages and update repo database
        run: |
          mkdir -p repo

          # Copy and sign newly built packages
          for pkgdir in ${{ steps.changes.outputs.packages }}; do
            for pkg in "$pkgdir"/*.pkg.tar.zst; do
              if [ -f "$pkg" ]; then
                cp "$pkg" repo/
                gpg --batch --yes --detach-sign --no-armor "repo/$(basename $pkg)"
              fi
            done
          done

          # Rename files with colons (GitHub converts : to . in asset names)
          for f in repo/*:*; do
            [ -f "$f" ] && mv "$f" "$(echo $f | tr ':' '.')"
          done

          # Update repo database (adds new packages to existing database)
          cd repo
          repo-add --sign --key ${{ secrets.GPG_KEY_ID }} m-wells.db.tar.gz *.pkg.tar.zst

      - name: Upload to release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create release if it doesn't exist
          gh release view latest --repo ${{ github.repository }} || \
            gh release create latest --repo ${{ github.repository }} --title "Packages" --notes "Arch Linux binary packages"

          # Upload files, overwriting any existing
          gh release upload latest repo/* --repo ${{ github.repository }} --clobber
