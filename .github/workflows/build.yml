name: Build packages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Rebuild all packages'
        type: boolean
        default: false
      fix_signatures:
        description: 'Fix database signatures without rebuilding'
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}
    container: archlinux:base-devel
    outputs:
      matrix: ${{ steps.scan.outputs.matrix }}
      removed: ${{ steps.scan.outputs.removed }}
      run_publish: ${{ steps.scan.outputs.run_publish }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup.sh

      - name: Lint PKGBUILDs
        run: ./scripts/lint.sh

      - name: Prepare build matrix
        id: scan
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_REBUILD: ${{ inputs.force_rebuild }}
          FIX_SIGNATURES: ${{ inputs.fix_signatures }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message || github.event.workflow_run.head_commit.message }}
        run: ./scripts/ci/prepare.sh

      - name: Upload Repository DB
        uses: actions/upload-artifact@v4
        with:
          name: repo-db
          path: repo/
          compression-level: 0

  aur-publish:
    needs: prepare
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}
    container: archlinux:base-devel
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup.sh

      - name: Publish to AUR
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        run: ./scripts/ci/aur-publish.sh

  build:
    needs: [prepare, aur-publish]
    if: ${{ always() && needs.prepare.result == 'success' && fromJson(needs.prepare.outputs.matrix)[0] != null }}
    runs-on: ${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}
    container: archlinux:base-devel
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup.sh

      - name: Build packages sequentially
        env:
          PACKAGES: ${{ needs.prepare.outputs.matrix }}
        run: |
          # Build packages one by one, each gets added to local repo
          # so subsequent packages can depend on earlier ones
          for pkg in $(echo "$PACKAGES" | jq -r '.[]'); do
            echo "::group::Building $pkg"
            ./scripts/ci/build.sh "$pkg"
            echo "::endgroup::"
          done

      - name: Upload Package Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: pkgs/*/*.pkg.tar.zst
          compression-level: 0

  publish:
    needs: [prepare, build]
    # Run if prepare succeeded, and build either succeeded or was skipped (no work), AND we are told to publish
    if: |
      always() &&
      needs.prepare.result == 'success' &&
      (needs.build.result == 'success' || needs.build.result == 'skipped') &&
      needs.prepare.outputs.run_publish == 'true' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      github.ref == 'refs/heads/main'
    runs-on: ${{ vars.RUNNER_LABEL || 'ubuntu-latest' }}
    container: archlinux:base-devel
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup.sh

      - name: Import GPG key
        run: echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

      - name: Download Repository DB
        uses: actions/download-artifact@v4
        with:
          name: repo-db
          path: repo

      - name: Download Built Packages
        # Only download if build job ran
        if: needs.build.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: packages
          path: repo-artifacts

      - name: Finalize Repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          REMOVED_JSON: ${{ needs.prepare.outputs.removed }}
        run: ./scripts/ci/publish.sh

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create release if it doesn't exist
          gh release view latest --repo ${{ github.repository }} || \
            gh release create latest --repo ${{ github.repository }} --title "Packages" --notes "Arch Linux binary packages"

          # Upload all contents of repo/ (excluding raw tarballs if we only want DBs and pkgs)
          # We sort -u to deduplicate if any globs overlap
          FILES_TO_UPLOAD=$(ls repo/*.pkg.tar.zst repo/*.sig repo/*.db.tar.gz repo/*.files.tar.gz repo/*.db.sig repo/*.files.sig repo/*.db repo/*.files 2>/dev/null | sort -u | tr '\n' ' ')

          if [ -n "$FILES_TO_UPLOAD" ]; then
             echo "Uploading: $FILES_TO_UPLOAD"
             gh release upload latest $FILES_TO_UPLOAD --repo ${{ github.repository }} --clobber
          else
             echo "No files to upload."
          fi
